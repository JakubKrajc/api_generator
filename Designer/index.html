<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Jakub Krajč">
    <link rel="icon" href="../../../../favicon.ico">

    <title>API Designer</title>

    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="designer.css" rel="stylesheet">
  </head>

  <body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
      <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">API Designer</a>
      <!--<ul class="navbar-nav px-3">
        <li class="nav-item text-nowrap">
          <a class="nav-link" href="#">Sign out</a>
        </li>
      </ul>-->
    </nav>

    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
          <div class="sidebar-sticky">
            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>Calls</span>
            </h6>
            <ul class="nav flex-column" id="CallsMenu">
              <li class="nav-item">
                <a class="nav-link" href="#">
                  [GET] /users/
                </a>
              </li>

              <li class="nav-item">
                <a class="nav-link" href="#">
                   [POST] /users/
                </a>
              </li>
              
              <li class="nav-item">
                <a class="nav-link" href="#">
                    <span data-feather="plus-circle"></span> Create new call
                </a>
              </li>
            </ul>

            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>Actions</span>
            </h6>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        ReLoad
                    </a>
                </li>
    
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        Save
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="#">
                        Import JSON
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        Export JSON
                    </a>
                </li>
            </ul>
            
          </div>
        </nav>

        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
          <div id="CallsCreateForm" >
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
              <h2>Create new call</h2>            
            </div>

            <div class="input-group">
              <select class="form-control" id="CallsCreateFormMethod">
                  <option value="GET">GET</option>
                  <option value="POST">POST</option>
                  <option value="PUT">PUT</option>
                  <option value="DELETE">DELETE</option>
              </select>
              <input type="text" class="form-control" id="CallsCreateFormURL" placeholder="/" />
              <div class="input-group-append">
                  <button class="btn btn-outline-secondary" id="CallsCreateFormSave" type="button">Save</button>
                </div>
            </div>

            <br />
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="true" id="CallsCreateFormAuthentification">
              <label class="form-check-label" for="CallsCreateFormAuthentification">
                  Required Authentification header
              </label>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="true" id="CallsCreateFormAuthorization">
              <label class="form-check-label" for="CallsCreateFormAuthorization">
                  Required Authorization (permission check)
              </label>
            </div>
            </div>

          <!--<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
            <h2>Call edit</h2>            
          </div>

          <div class="input-group">
            <select class="form-control" id="callEditMethod">
                <option>GET</option>
                <option>POST</option>
                <option>PUT</option>
                <option>DELETE</option>
            </select>
            <input type="text" class="form-control" placeholder="/" />
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button">Save</button>
              </div>
          </div>
          <br />
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="true" id="defaultCheck1">
            <label class="form-check-label" for="defaultCheck1">
                Required Authentification header
            </label>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="true" id="defaultCheck1">
            <label class="form-check-label" for="defaultCheck1">
                Required Authorization (permission check)
            </label>
          </div>

            <br /><br />


            <h4>URL parameters</h4> 


            <div class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Type</th>
                      <th>Description</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                       <td><input type="text" class="form-control" placeholder="Field description" value="user_id" readonly="true" /></td>
                       <td><select class="form-control">
                            <option>String</option>
                            <option>Text</option>
                            <option>Integer</option>
                            <option>Float</option>
                            <option>Date</option>
                            <option>Datetime</option>
                            <option>Time</option>
                        </select></td>
                       <td><input type="text" class="form-control" placeholder="Field description" value="User ID" /></td>
                       <td><button class="btn btn-outline-secondary" type="button">Save</button></td>
                    </tr>
                  </tbody>
                </table>
              </div>


             <h4>Data <small>(GET or POST based on method)</small></h4>

            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Required</th>
                        <th></th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><input type="text" class="form-control" placeholder="Field description" value="filter.name" /></td>
                        <td><select class="form-control">
                            <option>String</option>
                            <option>Text</option>
                            <option>Integer</option>
                            <option>Float</option>
                            <option>Date</option>
                            <option>Datetime</option>
                            <option>Time</option>
                        </select></td>
                        <td><input type="text" class="form-control" placeholder="Field description" value="Search by name" /></td>
                        <td><input class="form-check-input position-static" type="checkbox" value="true" /></td>
                        <td><button class="btn btn-outline-secondary" type="button">Save</button></td>
                        <td><button class="btn btn-outline-danger" type="button">Delete</button></td>
                    </tr>
                    <tr>
                        <td><input type="text" class="form-control" placeholder="Field description" value="filter.email" /></td>
                        <td><select class="form-control">
                            <option>String</option>
                            <option>Text</option>
                            <option>Integer</option>
                            <option>Float</option>
                            <option>Date</option>
                            <option>Datetime</option>
                            <option>Time</option>
                        </select></td>
                        <td><input type="text" class="form-control" placeholder="Field description" value="Search by email" /></td>
                        
                        <td><input class="form-check-input position-static" type="checkbox" value="true" /></td>
                        <td><button class="btn btn-outline-secondary" type="button">Save</button></td>
                        <td><button class="btn btn-outline-danger" type="button">Delete</button></td>
                    </tr>

                    <tr>
                        <td><input type="text" class="form-control" placeholder="Field name"  /></td>
                        <td><select class="form-control">
                            <option>String</option>
                            <option>Text</option>
                            <option>Integer</option>
                            <option>Float</option>
                            <option>Date</option>
                            <option>Datetime</option>
                            <option>Time</option>
                        </select></td>
                        <td><input type="text" class="form-control" placeholder="Field description" /></td>
                        <td><input class="form-check-input position-static" type="checkbox" value="true" /></td>
                        <td><button class="btn btn-outline-secondary" type="button">Create</button></td>
                        <td></td>
                    </tr>
                    </tbody>
                </table>
            </div>-->

            <!--<h4>Errors</h4>

            <div class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>HTTP Code</th>
                      <th>Message</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                       <td><input type="text" class="form-control" placeholder="200" value="401" readonly="true" /></td>
                       <td><pre>
{
    "status":{
        "msg":"Authentification required!"
        "code":401
    }
}
                       </pre></td>
                       <td></td>
                    </tr>
                    <tr>
                        <td><input type="text" class="form-control" placeholder="200" value="401" readonly="true" /></td>
                        <td><pre>
{
    "status":{
        "msg":"User not authorized!"
        "code":401
    }
}
                        </pre></td>
                        <td></td>
                     </tr>
                     <tr>
                        <td><input type="text" class="form-control" placeholder="200" value="400" /></td>
                        <td><pre>
{
    "status":{
        "msg":"Custom error!"
        "code":401
    }
}
                        </pre></td>
                        <td><button class="btn btn-outline-danger" type="button">Delete</button></td>
                     </tr>
                  </tbody>
                </table>
              </div>-->
        </main>
      </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>

    <!-- Graphs -->
    
    <script>
      function makeid(length) {
        var result           = '';
        var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        var charactersLength = characters.length;
        for ( var i = 0; i < length; i++ ) {
          result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
      }

      function CheckboxValue(elm){
        if(!elm){
          return false;
        }
        return (elm.checked);
      }

      function SelectValue(elm, def){
        if(!elm){
          return def;
        }

        if(!elm.selectedIndex){
          return def;
        }

        if(!elm.options){
          return def;
        }

        if(!elm.options[elm.selectedIndex]){
          return def;
        }

        return elm.options[elm.selectedIndex].value;
      }

      function CustomEvent(name, data){
        var self = this;
        self.name = name;
        self.data = data;
      }

      CustomEvent.prototype.name = "";
      CustomEvent.prototype.data = {};

      function CustomEventsController(){
        var self = this;
        self.events = {};
      }

      CustomEventsController.events = {};

      CustomEventsController.prototype.AddEventListener = function(name, callback){
        var self = this;
        if(!self.events[name]){
          self.events[name] = [];
        }

        self.events[name].push(callback);
      }

      CustomEventsController.prototype.DispachEvent = function(event){
        var self = this;
        var name = event.name;

        if(!self.events[name]){
          return;
        }

        for(var i in self.events[name]){
          var cb = self.events[name][i];
          cb(event);
        }
      }



      function APIURLParam(name){
        var self = this;

        self.name = name;
        self.type = "string";
        self.description = "";
      }

      APIURLParam.prototype.name = "";
      APIURLParam.prototype.type = "";
      APIURLParam.prototype.description = "";

      APIURLParam.SetType = function(type){
        var self = this;

        self.type = type;
      }

      APIURLParam.SetDesc = function(desc){
        var self = this;

        self.description = desc;
      }


      function APICall(method, url){
        var self = this;

        self.id = makeid(16);

        self.method = method;
        self.url_params = [];
        self.data = [];
        self.SetUrl(url);
        self.need_authentification = false;
        self.need_authorization = false;

      }

      APICall.prototype.id = 0;
      APICall.prototype.method = "GET";
      APICall.prototype.url = "/";
      APICall.prototype.need_authentification = false;
      APICall.prototype.need_authorization = false;
      APICall.prototype.url_params = [];
      APICall.prototype.data = [];

      APICall.prototype.GetListData = function(){
        
        var self = this;

        var data = {
          id:self.id,
          method:self.method,
          url:self.url
        };

        return data;
      }

      APICall.prototype.SetUrl = function(url){
        var self = this;
        //parse url params
        var re = /:(?<name>\w+)/g;
        var match = url.matchAll(re);
      
        var mt = match.next();

        //TODO: remove not used url_params

        while(!mt.done){
          var name = mt.value.groups.name;
          

          //check if already exists
          var exists = false;
          for(var i in self.url_params){
            if(self.url_params[i].name == name){
              exists = true;
              continue;
            }
          }

          //add to params list
          if(!exists){
            self.url_params.push(new APIURLParam(name));
          }     

          mt = match.next();     
        }

        self.url = url;
      }

      var APIDesigner = {};
      APIDesigner.data = {
        "calls":[]
      };

      APIDesigner.calls = {};

      APIDesigner.eventConroller = new CustomEventsController();

      APIDesigner.CreateCall = function(method, url){
        var self = this;
        var api_call = new APICall(method, url);
        self.calls[api_call.id] = api_call;

        self._onCallsChange();

        return api_call.id;
      }

      APIDesigner.GetCalls = function(){
        var self = this;

        var calls = [];

        for(var i in self.calls){
          calls.push(self.calls[i].GetListData())
        }

        return calls;
      }

      APIDesigner.GetCall = function(id){
        var self = this;
        if(!self.calls[id]){
          return null;
        }

        return self.calls[id];
      }

      APIDesigner.AddEventListener = function(name, callback){
        var self = this;
        self.eventConroller.AddEventListener(name, callback);
      }


      ///events
      APIDesigner._onCallsChange = function(){
        var self = this;
        var calls = self.GetCalls();
        console.log("OnCallsChange");

        //call event ??
        var event = new CustomEvent("OnCallsChange", calls);
        self.eventConroller.DispachEvent(event);
      }



      //test
      APIDesigner.AddEventListener("OnCallsChange", function(event){
        console.log(event);
      });


      APIDesignerView = {};

      APIDesignerView.designer = APIDesigner;
      APIDesignerView.call_menu_element = document.getElementById("CallsMenu");

      //create form
      APIDesignerView.call_create_form_element = document.getElementById("CallsCreateForm");
      APIDesignerView.call_create_form_method_element = document.getElementById("CallsCreateFormMethod");
      APIDesignerView.call_create_form_url_element = document.getElementById("CallsCreateFormURL");
      APIDesignerView.call_create_form_save_element = document.getElementById("CallsCreateFormSave");
      APIDesignerView.call_create_form_authentificaton_element = document.getElementById("CallsCreateFormAuthentification");
      APIDesignerView.call_create_form_authorization_element = document.getElementById("CallsCreateFormAuthorization");

      APIDesignerView.Init = function(){
        var self = this;

        self.designer.AddEventListener("OnCallsChange", function(event){
          self.DrawCallsMenu(event.data);
        });

        self.designer._onCallsChange();

        //create form
        self.call_create_form_element.style.display = 'none';
        self.call_create_form_save_element.onclick = function(){
          self.CallsCreateFormSave();
        }
      }

      APIDesignerView.DrawCallsMenu = function(call_list){
        var self = this;
        var source = '';

        for(var i in call_list){
          var call_item = call_list[i];
          source += self.DrawCallsMenuItem(call_item);
        }

        source += '<li class="nav-item">'+"\n";
        source += '  <a class="nav-link" href="javascript: APIDesignerView.CallsCreateForm();">'+"\n";
        source += '   Create new call'+"\n";
        source += '  </a>'+"\n";
        source += '</li>'+"\n";

        if(self.call_menu_element){
          self.call_menu_element.innerHTML = source;
        }
      }

      APIDesignerView.DrawCallsMenuItem = function(call_item){
        var source = '<li class="nav-item">'+"\n";
        source += '  <a class="nav-link" href="javascript: APIDesignerView.CallsEditForm(\''+call_item.id+'\');">'+"\n";
        source += '   ['+call_item.method+'] '+call_item.url+"\n";
        source += '  </a>'+"\n";
        source += '</li>'+"\n";

        return source;
      }

      APIDesignerView.CallsCreateForm = function(){
        //show create form
        var self = this;

        //todo reset values

        self.call_create_form_element.style.display = 'block';
      }
      APIDesignerView.CallsCreateFormSave = function(){
        var self = this;

        //get values
        var method = SelectValue(self.call_create_form_method_element, "GET");
        var url = self.call_create_form_url_element.value;

        //create call
        var call_id = self.designer.CreateCall(method, url);
        var call = self.designer.GetCall(call_id);

        if(call){
          //set checkbox values - TODO use setters (setting value should generate 401 or 403 errors posibility)
          self.designer.GetCall(call_id).need_authentification = CheckboxValue(self.call_create_form_authentificaton_element);
          self.designer.GetCall(call_id).need_authorization = CheckboxValue(self.call_create_form_authorization_element);

          //TODO: close create form, open edit form
        }        
      }


      APIDesignerView.Init();

    </script>
  </body>
</html>
